AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'sample-stepfunctions

  Sample SAM Template for sample-stepfunctions

  '
Parameters:
  MasterSecretArn:
    Description: Master Secret ARN
    Type: String
  MasterSecretsManagerKey:
    Description: KMS Key for the use of secrets across accounts
    Type: String
  Stage:
    Description: Environment
    Type: String
Resources:
  ApiGatewayApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: dev
  BranchValidationFailedSNSTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName:
        Fn::Sub: branch-validation-sns-topic
      TopicName:
        Fn::Sub: branch-validation-topic
  UpdataClassInfoSuccessSNSTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName:
        Fn::Sub: update-class-info-sns-topic
      TopicName:
        Fn::Sub: update-class-info-topic
  UpdateClassInfoStateMachineLogs:
    Type: AWS::Logs::LogGroup
  UpdateClassInfoStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      DefinitionUri: ../../statemachine/update_class_info.asl.json
      DefinitionSubstitutions:
        BranchCheckerFunctionArn:
          Fn::GetAtt:
          - BranchCheckerFunction
          - Arn
        UpdateClassInfoFunctionArn:
          Fn::GetAtt:
          - UpdateClassInfoFunction
          - Arn
        BranchValidationFailedSNSTopic:
          Ref: BranchValidationFailedSNSTopic
        UpdataClassInfoSuccessSNSTopic:
          Ref: UpdataClassInfoSuccessSNSTopic
      Events:
        HttpRequest:
          Type: Api
          Properties:
            Method: POST
            Path: /request
            RestApiId:
              Ref: ApiGatewayApi
      Policies:
      - LambdaInvokePolicy:
          FunctionName:
            Ref: BranchCheckerFunction
      - LambdaInvokePolicy:
          FunctionName:
            Ref: UpdateClassInfoFunction
      - SNSPublishMessagePolicy:
          TopicName:
            Fn::GetAtt:
            - BranchValidationFailedSNSTopic
            - TopicName
      - SNSPublishMessagePolicy:
          TopicName:
            Fn::GetAtt:
            - UpdataClassInfoSuccessSNSTopic
            - TopicName
  BranchCheckerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: BranchCheckerFunction
      Handler: app.lambdaHandler
      Runtime: nodejs12.x
      Environment:
        Variables:
          tablename:
            Ref: BranchInfoTable
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: BranchInfoTable
  UpdateClassInfoFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: UpdateClassInfoFunction
      Handler: app.lambdaHandler
      Runtime: nodejs12.x
      Environment:
        Variables:
          tablename:
            Ref: ClassInfoTable
      Policies:
      - DynamoDBWritePolicy:
          TableName:
            Ref: ClassInfoTable
  ClassInfoTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
      PrimaryKey:
        Name: ClassId
        Type: String
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1
  BranchInfoTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
      PrimaryKey:
        Name: branchCode
        Type: String
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1
Outputs:
  UpdateClassInfoStateMachineArn:
    Description: Update Class Information state machine ARN
    Value:
      Ref: UpdateClassInfoStateMachine
  UpdateClassInfoStateMachineRole:
    Description: IAM Role created for Update Class Information state machine based
      on the specified SAM Policy Templates
    Value:
      Fn::GetAtt:
      - UpdateClassInfoStateMachineRole
      - Arn
